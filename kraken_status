#!/bin/bash
# KrakenSDR System Status Script
# Location: /usr/local/bin/kraken_status

KRAKEN_PID="/var/run/kraken"
KRAKEN_LOG="/var/log/kraken"
KRAKEN_CONFIG="/etc/kraken"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# Check if process is running by PID file
is_process_running() {
    local pidfile="$1"
    if [ -f "$pidfile" ]; then
        local pid=$(cat "$pidfile")
        if kill -0 "$pid" 2>/dev/null; then
            return 0
        else
            rm -f "$pidfile"
            return 1
        fi
    fi
    return 1
}

# Get process CPU and memory usage
get_process_stats() {
    local pidfile="$1"
    if [ -f "$pidfile" ]; then
        local pid=$(cat "$pidfile")
        if kill -0 "$pid" 2>/dev/null; then
            ps -p $pid -o pcpu,pmem --no-headers 2>/dev/null | awk '{print $1 "%" " " $2 "%"}'
        else
            echo "- -"
        fi
    else
        echo "- -"
    fi
}

# Get system resource usage
get_system_resources() {
    # CPU usage (1 minute average)
    local cpu_load=$(uptime | awk -F'load average:' '{print $2}' | cut -d',' -f1 | xargs)
    local cpu_cores=$(nproc)
    local cpu_percent=$(echo "scale=1; $cpu_load * 100 / $cpu_cores" | bc 2>/dev/null || echo "0.0")
    
    # Memory usage
    local mem_info=$(free | grep Mem)
    local mem_total=$(echo $mem_info | awk '{print $2}')
    local mem_used=$(echo $mem_info | awk '{print $3}')
    local mem_percent=$(echo "scale=1; $mem_used * 100 / $mem_total" | bc 2>/dev/null || echo "0.0")
    
    # Disk usage
    local disk_usage=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
    
    # Temperature (if available)
    local temp="N/A"
    if [ -f "/sys/class/thermal/thermal_zone0/temp" ]; then
        local temp_raw=$(cat /sys/class/thermal/thermal_zone0/temp)
        temp=$(echo "scale=1; $temp_raw / 1000" | bc 2>/dev/null || echo "N/A")
        temp="${temp}°C"
    fi
    
    echo "$cpu_percent $mem_percent $disk_usage $temp"
}

# Check Elasticsearch connectivity
check_elasticsearch() {
    if curl -s http://localhost:9200/_cluster/health >/dev/null 2>&1; then
        local health=$(curl -s http://localhost:9200/_cluster/health | jq -r '.status' 2>/dev/null || echo "unknown")
        local doc_count=$(curl -s http://localhost:9200/kraken-sdr-*/_count 2>/dev/null | jq -r '.count // 0' 2>/dev/null || echo "0")
        echo "CONNECTED $health $doc_count"
    else
        echo "DISCONNECTED unknown 0"
    fi
}

# Check USB devices (KrakenSDR)
check_usb_devices() {
    local kraken_count=$(lsusb | grep -c "RTL2838" 2>/dev/null || echo "0")
    echo "$kraken_count"
}

# Show detailed system status
show_detailed_status() {
    clear
    echo -e "${WHITE}╔══════════════════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${WHITE}║                          KrakenSDR System Status                            ║${NC}"
    echo -e "${WHITE}║                              $(date)                              ║${NC}"
    echo -e "${WHITE}╚══════════════════════════════════════════════════════════════════════════════╝${NC}"
    echo
    
    # System Resources
    echo -e "${CYAN}╔═══ SYSTEM RESOURCES ═══════════════════════════════════════════════════════╗${NC}"
    local resources=$(get_system_resources)
    read cpu_percent mem_percent disk_percent temp <<< "$resources"
    
    printf "${CYAN}║${NC} %-15s ${BLUE}%6s${NC} %-15s ${BLUE}%6s${NC} %-15s ${BLUE}%6s${NC} %-15s ${BLUE}%8s${NC} ${CYAN}║${NC}\n" \
        "CPU Load:" "${cpu_percent}%" "Memory:" "${mem_percent}%" "Disk:" "${disk_percent}%" "Temperature:" "$temp"
    
    # Uptime
    local uptime_info=$(uptime -p 2>/dev/null || uptime | cut -d',' -f1)
    printf "${CYAN}║${NC} %-15s ${BLUE}%-60s${NC} ${CYAN}║${NC}\n" "Uptime:" "$uptime_info"
    echo -e "${CYAN}╚═══════════════════════════════════════════════════════════════════════════════╝${NC}"
    echo
    
    # Hardware Status
    echo -e "${YELLOW}╔═══ HARDWARE STATUS ════════════════════════════════════════════════════════╗${NC}"
    local usb_devices=$(check_usb_devices)
    if [ "$usb_devices" -gt 0 ]; then
        printf "${YELLOW}║${NC} KrakenSDR Devices: ${GREEN}%d detected${NC}%50s ${YELLOW}║${NC}\n" "$usb_devices" ""
    else
        printf "${YELLOW}║${NC} KrakenSDR Devices: ${RED}None detected${NC}%47s ${YELLOW}║${NC}\n" ""
    fi
    echo -e "${YELLOW}╚═══════════════════════════════════════════════════════════════════════════════╝${NC}"
    echo
    
    # Core Services
    echo -e "${BLUE}╔═══ CORE SERVICES ══════════════════════════════════════════════════════════╗${NC}"
    
    # Heimdall DAQ
    if systemctl is-active --quiet heimdall-daq 2>/dev/null; then
        printf "${BLUE}║${NC} %-20s ${GREEN}●${NC} %-10s %40s ${BLUE}║${NC}\n" "Heimdall DAQ" "RUNNING" ""
    else
        printf "${BLUE}║${NC} %-20s ${RED}●${NC} %-10s %40s ${BLUE}║${NC}\n" "Heimdall DAQ" "STOPPED" ""
    fi
    
    # DoA DSP Service
    if systemctl is-active --quiet kraken-doa 2>/dev/null; then
        printf "${BLUE}║${NC} %-20s ${GREEN}●${NC} %-10s %40s ${BLUE}║${NC}\n" "DoA DSP" "RUNNING" ""
    else
        printf "${BLUE}║${NC} %-20s ${RED}●${NC} %-10s %40s ${BLUE}║${NC}\n" "DoA DSP" "STOPPED" ""
    fi
    
    echo -e "${BLUE}╚═══════════════════════════════════════════════════════════════════════════════╝${NC}"
    echo
    
    # VFO Status
    echo -e "${GREEN}╔═══ VFO STATUS ═════════════════════════════════════════════════════════════╗${NC}"
    printf "${GREEN}║${NC} %-5s %-20s %-10s %-8s %-8s %-20s ${GREEN}║${NC}\n" "VFO" "Description" "Status" "CPU" "Memory" "Frequency"
    echo -e "${GREEN}╠═══════════════════════════════════════════════════════════════════════════════╣${NC}"
    
    local vfo_names=("" "Ham Emergency" "GMRS Channels" "Public Safety" "FM Reference" "Discovery Scanner")
    local vfo_freqs=("" "146.520 MHz" "462.675 MHz" "155.340 MHz" "101.5 MHz" "AUTO")
    
    for i in {1..5}; do
        local stats=$(get_process_stats "$KRAKEN_PID/vfo$i.pid")
        read cpu_usage mem_usage <<< "$stats"
        
        if is_process_running "$KRAKEN_PID/vfo$i.pid"; then
            printf "${GREEN}║${NC} %-5s %-20s ${GREEN}●${NC} %-9s %-8s %-8s %-20s ${GREEN}║${NC}\n" \
                "$i" "${vfo_names[$i]}" "RUNNING" "$cpu_usage" "$mem_usage" "${vfo_freqs[$i]}"
        else
            printf "${GREEN}║${NC} %-5s %-20s ${RED}●${NC} %-9s %-8s %-8s %-20s ${GREEN}║${NC}\n" \
                "$i" "${vfo_names[$i]}" "STOPPED" "-" "-" "${vfo_freqs[$i]}"
        fi
    done
    echo -e "${GREEN}╚═══════════════════════════════════════════════════════════════════════════════╝${NC}"
    echo
    
    # Processing Systems
    echo -e "${PURPLE}╔═══ PROCESSING SYSTEMS ═════════════════════════════════════════════════════╗${NC}"
    printf "${PURPLE}║${NC} %-25s %-10s %-8s %-8s %-20s ${PURPLE}║${NC}\n" "Component" "Status" "CPU" "Memory" "Description"
    echo -e "${PURPLE}╠═══════════════════════════════════════════════════════════════════════════════╣${NC}"
    
    # Passive Radar
    local radar_stats=$(get_process_stats "$KRAKEN_PID/radar.pid")
    read radar_cpu radar_mem <<< "$radar_stats"
    if is_process_running "$KRAKEN_PID/radar.pid"; then
        printf "${PURPLE}║${NC} %-25s ${GREEN}●${NC} %-9s %-8s %-8s %-20s ${PURPLE}║${NC}\n" \
            "Passive Radar" "RUNNING" "$radar_cpu" "$radar_mem" "Aircraft Detection"
    else
        printf "${PURPLE}║${NC} %-25s ${RED}●${NC} %-9s %-8s %-8s %-20s ${PURPLE}║${NC}\n" \
            "Passive Radar" "STOPPED" "-" "-" "Aircraft Detection"
    fi
    
    # Beamforming
    local beam_stats=$(get_process_stats "$KRAKEN_PID/beamform.pid")
    read beam_cpu beam_mem <<< "$beam_stats"
    if is_process_running "$KRAKEN_PID/beamform.pid"; then
        printf "${PURPLE}║${NC} %-25s ${GREEN}●${NC} %-9s %-8s %-8s %-20s ${PURPLE}║${NC}\n" \
            "Beamforming" "RUNNING" "$beam_cpu" "$beam_mem" "Spatial Filtering"
    else
        printf "${PURPLE}║${NC} %-25s ${RED}●${NC} %-9s %-8s %-8s %-20s ${PURPLE}║${NC}\n" \
            "Beamforming" "STOPPED" "-" "-" "Spatial Filtering"
    fi
    
    # Signal Classification
    local class_stats=$(get_process_stats "$KRAKEN_PID/classifier.pid")
    read class_cpu class_mem <<< "$class_stats"
    if is_process_running "$KRAKEN_PID/classifier.pid"; then
        printf "${PURPLE}║${NC} %-25s ${GREEN}●${NC} %-9s %-8s %-8s %-20s ${PURPLE}║${NC}\n" \
            "Signal Classifier" "RUNNING" "$class_cpu" "$class_mem" "Auto Identification"
    else
        printf "${PURPLE}║${NC} %-25s ${RED}●${NC} %-9s %-8s %-8s %-20s ${PURPLE}║${NC}\n" \
            "Signal Classifier" "STOPPED" "-" "-" "Auto Identification"
    fi
    
    # Discovery Scanner
    local disc_stats=$(get_process_stats "$KRAKEN_PID/discovery.pid")
    read disc_cpu disc_mem <<< "$disc_stats"
    if is_process_running "$KRAKEN_PID/discovery.pid"; then
        printf "${PURPLE}║${NC} %-25s ${GREEN}●${NC} %-9s %-8s %-8s %-20s ${PURPLE}║${NC}\n" \
            "Discovery Scanner" "RUNNING" "$disc_cpu" "$disc_mem" "Wideband Scan"
    else
        printf "${PURPLE}║${NC} %-25s ${RED}●${NC} %-9s %-8s %-8s %-20s ${PURPLE}║${NC}\n" \
            "Discovery Scanner" "STOPPED" "-" "-" "Wideband Scan"
    fi
    
    echo -e "${PURPLE}╚═══════════════════════════════════════════════════════════════════════════════╝${NC}"
    echo
    
    # External Services
    echo -e "${CYAN}╔═══ EXTERNAL SERVICES ══════════════════════════════════════════════════════╗${NC}"
    
    # Elasticsearch
    local es_info=$(check_elasticsearch)
    read es_status es_health es_docs <<< "$es_info"
    
    if [ "$es_status" = "CONNECTED" ]; then
        case $es_health in
            "green")
                printf "${CYAN}║${NC} %-20s ${GREEN}●${NC} %-15s ${GREEN}%-10s${NC} %-15s ${BLUE}%10s${NC} ${CYAN}║${NC}\n" \
                    "Elasticsearch" "CONNECTED" "$es_health" "Documents:" "$es_docs"
                ;;
            "yellow")
                printf "${CYAN}║${NC} %-20s ${GREEN}●${NC} %-15s ${YELLOW}%-10s${NC} %-15s ${BLUE}%10s${NC} ${CYAN}║${NC}\n" \
                    "Elasticsearch" "CONNECTED" "$es_health" "Documents:" "$es_docs"
                ;;
            "red")
                printf "${CYAN}║${NC} %-20s ${GREEN}●${NC} %-15s ${RED}%-10s${NC} %-15s ${BLUE}%10s${NC} ${CYAN}║${NC}\n" \
                    "Elasticsearch" "CONNECTED" "$es_health" "Documents:" "$es_docs"
                ;;
        esac
    else
        printf "${CYAN}║${NC} %-20s ${RED}●${NC} %-15s %-10s %-15s %10s ${CYAN}║${NC}\n" \
            "Elasticsearch" "DISCONNECTED" "-" "-" "-"
    fi
    
    # Data Streamer
    local stream_stats=$(get_process_stats "$KRAKEN_PID/elasticsearch.pid")
    read stream_cpu stream_mem <<< "$stream_stats"
    if is_process_running "$KRAKEN_PID/elasticsearch.pid"; then
        printf "${CYAN}║${NC} %-20s ${GREEN}●${NC} %-15s %-10s %-8s %-8s ${CYAN}║${NC}\n" \
            "Data Streamer" "RUNNING" "$stream_cpu" "$stream_mem" ""
    else
        printf "${CYAN}║${NC} %-20s ${RED}●${NC} %-15s %-10s %-8s %-8s ${CYAN}║${NC}\n" \
            "Data Streamer" "STOPPED" "-" "-" ""
    fi
    
    echo -e "${CYAN}╚═══════════════════════════════════════════════════════════════════════════════╝${NC}"
    echo
    
    # Summary
    local running_vfos=0
    for i in {1..5}; do
        if is_process_running "$KRAKEN_PID/vfo$i.pid"; then
            ((running_vfos++))
        fi
    done
    
    local running_processes=0
    local total_processes=0
    for pidfile in $KRAKEN_PID/*.pid; do
        if [ -f "$pidfile" ]; then
            ((total_processes++))
            if is_process_running "$pidfile"; then
                ((running_processes++))
            fi
        fi
    done
    
    echo -e "${WHITE}╔═══ SUMMARY ════════════════════════════════════════════════════════════════╗${NC}"
    printf "${WHITE}║${NC} Active VFOs: ${BLUE}%d/5${NC}     Running Processes: ${BLUE}%d/%d${NC}     System Load: ${BLUE}%s%%${NC}%15s ${WHITE}║${NC}\n" \
        "$running_vfos" "$running_processes" "$total_processes" "$cpu_percent" ""
    echo -e "${WHITE}╚═══════════════════════════════════════════════════════════════════════════════╝${NC}"
}

# Show compact status
show_compact_status() {
    echo -e "${BLUE}KrakenSDR Status - $(date '+%H:%M:%S')${NC}"
    echo "=================================="
    
    # Quick system info
    local resources=$(get_system_resources)
    read cpu_percent mem_percent disk_percent temp <<< "$resources"
    echo -e "System: CPU ${BLUE}${cpu_percent}%${NC} | Memory ${BLUE}${mem_percent}%${NC} | Disk ${BLUE}${disk_percent}%${NC}"
    
    # VFO status
    echo -n "VFOs: "
    for i in {1..5}; do
        if is_process_running "$KRAKEN_PID/vfo$i.pid"; then
            echo -ne "${GREEN}$i${NC} "
        else
            echo -ne "${RED}$i${NC} "
        fi
    done
    echo
    
    # Other processes
    echo -n "Systems: "
    if is_process_running "$KRAKEN_PID/radar.pid"; then
        echo -ne "${GREEN}R${NC} "
    else
        echo -ne "${RED}R${NC} "
    fi
    
    if is_process_running "$KRAKEN_PID/beamform.pid"; then
        echo -ne "${GREEN}B${NC} "
    else
        echo -ne "${RED}B${NC} "
    fi
    
    if is_process_running "$KRAKEN_PID/classifier.pid"; then
        echo -ne "${GREEN}C${NC} "
    else
        echo -ne "${RED}C${NC} "
    fi
    
    if is_process_running "$KRAKEN_PID/elasticsearch.pid"; then
        echo -ne "${GREEN}E${NC}"
    else
        echo -ne "${RED}E${NC}"
    fi
    echo
    
    # Elasticsearch
    local es_info=$(check_elasticsearch)
    read es_status es_health es_docs <<< "$es_info"
    if [ "$es_status" = "CONNECTED" ]; then
        echo -e "Elasticsearch: ${GREEN}●${NC} $es_health ($es_docs docs)"
    else
        echo -e "Elasticsearch: ${RED}●${NC} Disconnected"
    fi
}

# Show usage
show_usage() {
    echo "Usage: $0 [OPTIONS]"
    echo
    echo "Options:"
    echo "  --detailed, -d    Show detailed status display"
    echo "  --compact, -c     Show compact status (default)"
    echo "  --json, -j        Output status in JSON format"
    echo "  --watch, -w       Watch mode (refresh every 2 seconds)"
    echo "  --help, -h        Show this help message"
    echo
    echo "Examples:"
    echo "  $0                Show compact status"
    echo "  $0 --detailed     Show detailed status"
    echo "  $0 --watch        Watch mode with auto-refresh"
    echo "  $0 --json         JSON output for scripts"
}

# JSON output
show_json_status() {
    local resources=$(get_system_resources)
    read cpu_percent mem_percent disk_percent temp <<< "$resources"
    
    local es_info=$(check_elasticsearch)
    read es_status es_health es_docs <<< "$es_info"
    
    echo "{"
    echo "  \"timestamp\": \"$(date -Iseconds)\","
    echo "  \"system\": {"
    echo "    \"cpu_percent\": $cpu_percent,"
    echo "    \"memory_percent\": $mem_percent,"
    echo "    \"disk_percent\": $disk_percent,"
    echo "    \"temperature\": \"$temp\""
    echo "  },"
    echo "  \"vfos\": {"
    for i in {1..5}; do
        if is_process_running "$KRAKEN_PID/vfo$i.pid"; then
            echo "    \"vfo$i\": \"running\","
        else
            echo "    \"vfo$i\": \"stopped\","
        fi
    done | sed '$ s/,$//'
    echo "  },"
    echo "  \"processes\": {"
    echo "    \"passive_radar\": \"$(is_process_running "$KRAKEN_PID/radar.pid" && echo "running" || echo "stopped")\","
    echo "    \"beamforming\": \"$(is_process_running "$KRAKEN_PID/beamform.pid" && echo "running" || echo "stopped")\","
    echo "    \"classifier\": \"$(is_process_running "$KRAKEN_PID/classifier.pid" && echo "running" || echo "stopped")\","
    echo "    \"elasticsearch\": \"$(is_process_running "$KRAKEN_PID/elasticsearch.pid" && echo "running" || echo "stopped")\""
    echo "  },"
    echo "  \"elasticsearch\": {"
    echo "    \"status\": \"$es_status\","
    echo "    \"health\": \"$es_health\","
    echo "    \"documents\": $es_docs"
    echo "  }"
    echo "}"
}

# Parse command line arguments
MODE="compact"
WATCH=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --detailed|-d)
            MODE="detailed"
            shift
            ;;
        --compact|-c)
            MODE="compact"
            shift
            ;;
        --json|-j)
            MODE="json"
            shift
            ;;
        --watch|-w)
            WATCH=true
            shift
            ;;
        --help|-h)
            show_usage
            exit 0
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            show_usage
            exit 1
            ;;
    esac
done

# Execute based on mode
if [ "$WATCH" = true ]; then
    echo -e "${GREEN}Watch mode active - Press Ctrl+C to exit${NC}"
    echo
    while true; do
        case $MODE in
            detailed)
                show_detailed_status
                ;;
            compact)
                clear
                show_compact_status
                ;;
            json)
                show_json_status
                ;;
        esac
        sleep 2
    done
else
    case $MODE in
        detailed)
            show_detailed_status
            ;;
        compact)
            show_compact_status
            ;;
        json)
            show_json_status
            ;;
    esac
fi
