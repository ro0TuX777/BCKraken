#!/bin/bash
# KrakenSDR Maximum Utilization Control Script
# Location: /usr/local/bin/kraken_max_util

KRAKEN_CONFIG="/etc/kraken/max_utilization.json"
KRAKEN_LOG="/var/log/kraken"
KRAKEN_PID="/var/run/kraken"
KRAKEN_DATA="/var/lib/kraken"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Create directories if they don't exist
init_directories() {
    sudo mkdir -p $KRAKEN_LOG $KRAKEN_PID $KRAKEN_DATA /etc/kraken
    sudo chown $USER:$USER $KRAKEN_LOG $KRAKEN_PID $KRAKEN_DATA 2>/dev/null || true
}

# Log function
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a $KRAKEN_LOG/kraken_control.log
}

# Check if process is running
is_running() {
    local pidfile="$1"
    if [ -f "$pidfile" ]; then
        local pid=$(cat "$pidfile")
        if kill -0 "$pid" 2>/dev/null; then
            return 0
        else
            rm -f "$pidfile"
            return 1
        fi
    fi
    return 1
}

# Start maximum utilization mode
start_max_utilization() {
    echo -e "${GREEN}Starting KrakenSDR Maximum Utilization Mode...${NC}"
    log_message "Starting maximum utilization mode"
    
    init_directories
    
    # Start Heimdall DAQ
    echo -n "Starting Heimdall DAQ... "
    if systemctl start heimdall-daq 2>/dev/null; then
        echo -e "${GREEN}✓${NC}"
        log_message "Heimdall DAQ started successfully"
    else
        echo -e "${RED}✗${NC}"
        log_message "Failed to start Heimdall DAQ"
    fi
    sleep 2
    
    # Start VFO 1 (Ham Emergency - 146.520 MHz)
    echo -n "Starting VFO 1 (Ham Emergency)... "
    if python3 /home/pi/krakensdr_doa/scripts/vfo_control.py \
        --vfo 1 --frequency 146520000 --algorithm MUSIC --daemon \
        --pidfile $KRAKEN_PID/vfo1.pid 2>/dev/null; then
        echo -e "${GREEN}✓${NC}"
        log_message "VFO 1 started successfully"
    else
        echo -e "${RED}✗${NC}"
        log_message "Failed to start VFO 1"
    fi
    
    # Start VFO 2 (GMRS - 462.675 MHz)
    echo -n "Starting VFO 2 (GMRS Scan)... "
    if python3 /home/pi/krakensdr_doa/scripts/vfo_control.py \
        --vfo 2 --frequency 462675000 --algorithm Bartlett --mode SCAN --daemon \
        --pidfile $KRAKEN_PID/vfo2.pid 2>/dev/null; then
        echo -e "${GREEN}✓${NC}"
        log_message "VFO 2 started successfully"
    else
        echo -e "${RED}✗${NC}"
        log_message "Failed to start VFO 2"
    fi
    
    # Start VFO 3 (Public Safety - 155.340 MHz)
    echo -n "Starting VFO 3 (Public Safety)... "
    if python3 /home/pi/krakensdr_doa/scripts/vfo_control.py \
        --vfo 3 --frequency 155340000 --algorithm Capon --mode PRIORITY --daemon \
        --pidfile $KRAKEN_PID/vfo3.pid 2>/dev/null; then
        echo -e "${GREEN}✓${NC}"
        log_message "VFO 3 started successfully"
    else
        echo -e "${RED}✗${NC}"
        log_message "Failed to start VFO 3"
    fi
    
    # Start Passive Radar (VFO 4 + reference)
    echo -n "Starting Passive Radar... "
    if python3 /home/pi/krakensdr_doa/scripts/passive_radar.py \
        --illuminator FM_101.5 --surveillance-channels 2,3,4,5 --daemon \
        --pidfile $KRAKEN_PID/radar.pid 2>/dev/null; then
        echo -e "${GREEN}✓${NC}"
        log_message "Passive radar started successfully"
    else
        echo -e "${RED}✗${NC}"
        log_message "Failed to start passive radar"
    fi
    
    # Start Discovery Scanner (VFO 5)
    echo -n "Starting Discovery Scanner... "
    if python3 /home/pi/krakensdr_doa/scripts/discovery_scan.py \
        --range 24e6:1766e6 --step 25e3 --daemon \
        --pidfile $KRAKEN_PID/discovery.pid 2>/dev/null; then
        echo -e "${GREEN}✓${NC}"
        log_message "Discovery scanner started successfully"
    else
        echo -e "${RED}✗${NC}"
        log_message "Failed to start discovery scanner"
    fi
    
    # Start Beamforming Processor
    echo -n "Starting Adaptive Beamforming... "
    if python3 /home/pi/krakensdr_doa/scripts/beamforming.py \
        --adaptive --nulling --daemon \
        --pidfile $KRAKEN_PID/beamform.pid 2>/dev/null; then
        echo -e "${GREEN}✓${NC}"
        log_message "Beamforming started successfully"
    else
        echo -e "${RED}✗${NC}"
        log_message "Failed to start beamforming"
    fi
    
    # Start Signal Classification
    echo -n "Starting Signal Classification... "
    if python3 /home/pi/krakensdr_doa/scripts/signal_classifier.py \
        --all-channels --daemon \
        --pidfile $KRAKEN_PID/classifier.pid 2>/dev/null; then
        echo -e "${GREEN}✓${NC}"
        log_message "Signal classifier started successfully"
    else
        echo -e "${RED}✗${NC}"
        log_message "Failed to start signal classifier"
    fi
    
    # Start Elasticsearch Streamer
    echo -n "Starting Elasticsearch Data Stream... "
    if python3 /home/pi/krakensdr_doa/scripts/elasticsearch_streamer.py \
        --real-time --daemon \
        --pidfile $KRAKEN_PID/elasticsearch.pid 2>/dev/null; then
        echo -e "${GREEN}✓${NC}"
        log_message "Elasticsearch streamer started successfully"
    else
        echo -e "${RED}✗${NC}"
        log_message "Failed to start Elasticsearch streamer"
    fi
    
    echo
    echo -e "${GREEN}Maximum Utilization Mode Started!${NC}"
    echo -e "${YELLOW}Use 'kraken_max_util status' to monitor systems${NC}"
    log_message "Maximum utilization mode startup completed"
}

# Stop all systems
stop_max_utilization() {
    echo -e "${YELLOW}Stopping KrakenSDR Maximum Utilization Mode...${NC}"
    log_message "Stopping maximum utilization mode"
    
    # Kill all processes
    for pidfile in $KRAKEN_PID/*.pid; do
        if [ -f "$pidfile" ]; then
            pid=$(cat "$pidfile")
            process_name=$(basename "$pidfile" .pid)
            echo -n "Stopping $process_name... "
            if kill -TERM "$pid" 2>/dev/null; then
                # Wait for graceful shutdown
                sleep 2
                if kill -0 "$pid" 2>/dev/null; then
                    kill -KILL "$pid" 2>/dev/null
                fi
                echo -e "${GREEN}✓${NC}"
                log_message "$process_name stopped successfully"
            else
                echo -e "${YELLOW}not running${NC}"
            fi
            rm -f "$pidfile"
        fi
    done
    
    # Stop systemd services
    echo -n "Stopping Heimdall DAQ... "
    if systemctl stop heimdall-daq 2>/dev/null; then
        echo -e "${GREEN}✓${NC}"
        log_message "Heimdall DAQ stopped successfully"
    else
        echo -e "${YELLOW}not running${NC}"
    fi
    
    echo
    echo -e "${GREEN}All systems stopped.${NC}"
    log_message "Maximum utilization mode shutdown completed"
}

# Show system status
show_status() {
    echo -e "${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║                KrakenSDR System Status                      ║${NC}"
    echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}"
    echo
    
    # Check systemd services
    echo -e "${YELLOW}--- Core Services ---${NC}"
    if systemctl is-active --quiet heimdall-daq; then
        echo -e "Heimdall DAQ: ${GREEN}●${NC} RUNNING"
    else
        echo -e "Heimdall DAQ: ${RED}●${NC} STOPPED"
    fi
    
    # Check VFO processes
    echo
    echo -e "${YELLOW}--- VFO Status ---${NC}"
    vfo_names=("" "Ham Emergency" "GMRS Scan" "Public Safety" "FM Reference" "Discovery")
    for i in {1..5}; do
        if is_running "$KRAKEN_PID/vfo$i.pid"; then
            echo -e "VFO $i (${vfo_names[$i]}): ${GREEN}●${NC} RUNNING"
        else
            echo -e "VFO $i (${vfo_names[$i]}): ${RED}●${NC} STOPPED"
        fi
    done
    
    # Check other processes
    echo
    echo -e "${YELLOW}--- Processing Systems ---${NC}"
    processes=("radar:Passive Radar" "discovery:Discovery Scanner" "beamform:Beamforming" "classifier:Signal Classifier" "elasticsearch:Data Streamer")
    for process in "${processes[@]}"; do
        IFS=':' read -r pid_name display_name <<< "$process"
        if is_running "$KRAKEN_PID/$pid_name.pid"; then
            echo -e "$display_name: ${GREEN}●${NC} RUNNING"
        else
            echo -e "$display_name: ${RED}●${NC} STOPPED"
        fi
    done
    
    # Check Elasticsearch connectivity
    echo
    echo -e "${YELLOW}--- External Services ---${NC}"
    if curl -s http://localhost:9200/_cluster/health >/dev/null 2>&1; then
        echo -e "Elasticsearch: ${GREEN}●${NC} CONNECTED"
        doc_count=$(curl -s http://localhost:9200/kraken-*/_count 2>/dev/null | jq -r '.count // 0' 2>/dev/null || echo "0")
        echo -e "Documents indexed: ${BLUE}$doc_count${NC}"
    else
        echo -e "Elasticsearch: ${RED}●${NC} DISCONNECTED"
    fi
    
    # System resources
    echo
    echo -e "${YELLOW}--- System Resources ---${NC}"
    echo -e "CPU Load: ${BLUE}$(uptime | awk -F'load average:' '{print $2}' | cut -d',' -f1 | xargs)${NC}"
    echo -e "Memory: ${BLUE}$(free | grep Mem | awk '{printf "%.1f%%", $3/$2 * 100.0}')${NC} used"
    echo -e "Disk: ${BLUE}$(df / | tail -1 | awk '{print $5}')${NC} used"
}

# Real-time monitoring
monitor_real_time() {
    echo -e "${GREEN}Starting real-time monitoring...${NC}"
    echo -e "${YELLOW}Press Ctrl+C to exit${NC}"
    echo
    
    while true; do
        clear
        echo -e "${BLUE}KrakenSDR Real-time Monitor - $(date)${NC}"
        echo "================================================================"
        
        # Quick status
        running_count=0
        for i in {1..5}; do
            if is_running "$KRAKEN_PID/vfo$i.pid"; then
                ((running_count++))
            fi
        done
        
        echo -e "Active VFOs: ${GREEN}$running_count/5${NC}"
        
        if is_running "$KRAKEN_PID/radar.pid"; then
            echo -e "Passive Radar: ${GREEN}●${NC} ACTIVE"
        else
            echo -e "Passive Radar: ${RED}●${NC} INACTIVE"
        fi
        
        # Show recent log entries
        echo
        echo -e "${YELLOW}Recent Activity:${NC}"
        if [ -f "$KRAKEN_LOG/kraken_control.log" ]; then
            tail -5 "$KRAKEN_LOG/kraken_control.log" | while read line; do
                echo "  $line"
            done
        fi
        
        sleep 5
    done
}

# Main script logic
case "$1" in
    start)
        start_max_utilization
        ;;
    stop)
        stop_max_utilization
        ;;
    restart)
        stop_max_utilization
        sleep 3
        start_max_utilization
        ;;
    status)
        show_status
        ;;
    monitor)
        monitor_real_time
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status|monitor}"
        echo
        echo "Commands:"
        echo "  start   - Start maximum utilization mode (all VFOs, passive radar, etc.)"
        echo "  stop    - Stop all KrakenSDR processes"
        echo "  restart - Restart all processes"
        echo "  status  - Show status of all components"
        echo "  monitor - Real-time monitoring display"
        exit 1
        ;;
esac
