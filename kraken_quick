#!/bin/bash
# Quick action buttons for common KrakenSDR operations

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

show_quick_menu() {
    clear
    echo -e "${BLUE}╔════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║         KrakenSDR Quick Actions       ║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════╝${NC}"
    echo
    echo -e "${GREEN}[SPACE]${NC} Start Max Utilization    ${RED}[S]${NC} Stop All"
    echo -e "${YELLOW}[1-5]${NC}   Toggle VFO 1-5          ${BLUE}[R]${NC} Restart"
    echo -e "${PURPLE}[P]${NC}     Toggle Passive Radar   ${CYAN}[M]${NC} Monitor"
    echo -e "${YELLOW}[Q]${NC}     Quit"
    echo
    
    # Show current status in one line
    echo -n "Status: "
    for i in {1..5}; do
        if [ -f "/var/run/kraken/vfo$i.pid" ] && kill -0 $(cat "/var/run/kraken/vfo$i.pid") 2>/dev/null; then
            echo -ne "${GREEN}$i${NC} "
        else
            echo -ne "${RED}$i${NC} "
        fi
    done
    
    if [ -f "/var/run/kraken/radar.pid" ] && kill -0 $(cat "/var/run/kraken/radar.pid") 2>/dev/null; then
        echo -ne "${GREEN}R${NC}"
    else
        echo -ne "${RED}R${NC}"
    fi
    echo
    echo
}

# Main quick interface loop
while true; do
    show_quick_menu
    echo -e "${CYAN}Press a key:${NC}"
    read -n 1 -s key
    
    case $key in
        ' ')  # Space bar - start max utilization
            echo -e "\n${GREEN}Starting Maximum Utilization...${NC}"
            kraken_max_util start
            echo -e "${CYAN}Press any key to continue...${NC}"
            read -n 1 -s
            ;;
        [1-5])  # Toggle individual VFOs
            vfo_num=$key
            if [ -f "/var/run/kraken/vfo$vfo_num.pid" ] && kill -0 $(cat "/var/run/kraken/vfo$vfo_num.pid") 2>/dev/null; then
                echo -e "\n${YELLOW}Stopping VFO $vfo_num...${NC}"
                kraken_vfo --stop --vfo $vfo_num
            else
                echo -e "\n${GREEN}Starting VFO $vfo_num...${NC}"
                case $vfo_num in
                    1) kraken_vfo --start --vfo 1 --frequency 146.520e6 --algorithm MUSIC ;;
                    2) kraken_vfo --start --vfo 2 --frequency 462.675e6 --algorithm Bartlett ;;
                    3) kraken_vfo --start --vfo 3 --frequency 155.340e6 --algorithm Capon ;;
                    4) kraken_vfo --start --vfo 4 --frequency 101.5e6 --mode REFERENCE ;;
                    5) kraken_vfo --start --vfo 5 --frequency AUTO --algorithm MEMS ;;
                esac
            fi
            sleep 1
            ;;
        [Ss])  # Stop all
            echo -e "\n${RED}Stopping all systems...${NC}"
            kraken_max_util stop
            echo -e "${CYAN}Press any key to continue...${NC}"
            read -n 1 -s
            ;;
        [Pp])  # Toggle passive radar
            if [ -f "/var/run/kraken/radar.pid" ] && kill -0 $(cat "/var/run/kraken/radar.pid") 2>/dev/null; then
                echo -e "\n${YELLOW}Stopping Passive Radar...${NC}"
                kraken_radar --stop
            else
                echo -e "\n${GREEN}Starting Passive Radar...${NC}"
                kraken_radar --start --illuminator FM_101.5 --channels 2,3,4,5
            fi
            sleep 1
            ;;
        [Rr])  # Restart all
            echo -e "\n${YELLOW}Restarting all systems...${NC}"
            kraken_max_util restart
            echo -e "${CYAN}Press any key to continue...${NC}"
            read -n 1 -s
            ;;
        [Mm])  # Monitor mode
            echo -e "\n${BLUE}Entering monitor mode... (Press ESC to exit)${NC}"
            kraken_monitor --mode overview &
            MONITOR_PID=$!
            while read -n 1 -s monitor_key; do
                if [[ $monitor_key == $'\e' ]]; then
                    kill $MONITOR_PID 2>/dev/null
                    break
                fi
            done
            ;;
        [Qq])  # Quit
            echo -e "\n${GREEN}Goodbye!${NC}"
            exit 0
            ;;
        *)
            echo -e "\n${RED}Invalid key. Press any key to continue...${NC}"
            read -n 1 -s
            ;;
    esac
done
