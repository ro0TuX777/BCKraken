#!/bin/bash
# KrakenSDR Interactive Menu System

# Colors for better visibility
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Clear screen and show header
clear_and_header() {
    clear
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${CYAN}‚ïë                    KrakenSDR Control Center                  ‚ïë${NC}"
    echo -e "${CYAN}‚ïë                  Terminal Button Interface                   ‚ïë${NC}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo
}

# Show comprehensive system status with live data
show_status() {
    echo -e "${YELLOW}‚ïê‚ïê‚ïê SYSTEM STATUS & LIVE DATA ‚ïê‚ïê‚ïê${NC}"

    # System Health
    local cpu_load=$(uptime | awk -F'load average:' '{print $2}' | cut -d',' -f1 | xargs)
    local mem_usage=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
    echo -e "  System: CPU ${BLUE}${cpu_load}${NC} | Memory ${BLUE}${mem_usage}%${NC}"

    # Core Services
    if systemctl is-active --quiet heimdall-daq; then
        echo -e "  Heimdall DAQ: ${GREEN}‚óè${NC} RUNNING"
    else
        echo -e "  Heimdall DAQ: ${RED}‚óè${NC} STOPPED"
    fi

    # VFOs with frequencies
    local vfo_freqs=("" "146.520MHz" "462.675MHz" "155.340MHz" "101.5MHz" "AUTO")
    for i in {1..5}; do
        if pgrep -f "vfo$i" >/dev/null 2>&1; then
            echo -e "  VFO $i (${vfo_freqs[$i]}): ${GREEN}‚óè${NC} ACTIVE"
        else
            echo -e "  VFO $i (${vfo_freqs[$i]}): ${RED}‚óè${NC} INACTIVE"
        fi
    done

    # Processing Systems
    if pgrep -f "passive_radar" >/dev/null 2>&1; then
        echo -e "  Passive Radar: ${GREEN}‚óè${NC} RUNNING"
    else
        echo -e "  Passive Radar: ${RED}‚óè${NC} STOPPED"
    fi

    # Data Export
    if curl -s -u filebeat-dragonos:KUX4hkxjwp9qhu2wjx -k "https://172.18.18.20:9200/_cluster/health" >/dev/null 2>&1; then
        local doc_count=$(curl -s -u filebeat-dragonos:KUX4hkxjwp9qhu2wjx -k "https://172.18.18.20:9200/kraken-sdr-*/_count" 2>/dev/null | jq -r '.count // 0' 2>/dev/null || echo "0")
        echo -e "  Elasticsearch: ${GREEN}‚óè${NC} CONNECTED (${BLUE}${doc_count}${NC} docs)"
    else
        echo -e "  Elasticsearch: ${RED}‚óè${NC} DISCONNECTED"
    fi

    # Live Activity Summary
    if [ -d "../data/kraken" ] && [ "$(ls -A ../data/kraken 2>/dev/null)" ]; then
        echo -e "${CYAN}  Recent Activity:${NC}"
        if [ -f "../data/kraken/kraken-doa-"*.json ]; then
            local latest_bearing=$(tail -1 ../data/kraken/kraken-doa-*.json 2>/dev/null | jq -r '.bearing_degrees // 0' 2>/dev/null | cut -d. -f1)
            local latest_freq=$(tail -1 ../data/kraken/kraken-doa-*.json 2>/dev/null | jq -r '.frequency_hz // 0' 2>/dev/null | awk '{printf "%.1f", $1/1e6}')
            echo -e "    üìç Latest Signal: ${BLUE}${latest_freq}MHz${NC} at ${BLUE}${latest_bearing}¬∞${NC}"
        fi
        if [ -f "../data/kraken/kraken-radar-"*.json ]; then
            local target_count=$(wc -l < ../data/kraken/kraken-radar-*.json 2>/dev/null || echo "0")
            echo -e "    üõ°Ô∏è Radar Targets: ${BLUE}${target_count}${NC} detected"
        fi
    fi

    echo
}

# Main menu
main_menu() {
    while true; do
        clear_and_header
        show_status
        
        echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
        echo -e "${BLUE}‚ïë                        MAIN MENU                            ‚ïë${NC}"
        echo -e "${BLUE}‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[1]${NC} Start Maximum Utilization Mode                    ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[2]${NC} Stop All Systems                                  ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[3]${NC} VFO Control Menu                                  ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[4]${NC} Toggle Passive Radar                             ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[5]${NC} Live Monitor Mode                                ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[6]${NC} Data Query & Analysis                            ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[7]${NC} View Live Activity Logs                          ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[8]${NC} System Configuration                             ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[0]${NC} Quit                                             ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
        echo
        echo -e "${CYAN}Enter your choice [1-8, 0 to quit]:${NC}"
        
        read -n 1 -s choice
        echo
        
        case $choice in
            1)
                start_max_utilization_menu
                ;;
            2)
                stop_all_systems_menu
                ;;
            3)
                vfo_control_menu
                ;;
            4)
                toggle_passive_radar
                ;;
            5)
                live_monitor_mode
                ;;
            6)
                data_query_menu
                ;;
            7)
                view_live_logs
                ;;
            8)
                system_config_menu
                ;;
            0)
                echo -e "${GREEN}Goodbye!${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}Invalid choice. Please enter 1-8 or 0 to quit.${NC}"
                echo -e "${CYAN}Press any key to continue...${NC}"
                read -n 1 -s
                ;;
        esac
    done
}

# Start maximum utilization menu with continuous scanning
start_max_utilization_menu() {
    clear_and_header
    echo -e "${GREEN}‚ïê‚ïê‚ïê CONTINUOUS SCANNING MODE ‚ïê‚ïê‚ïê${NC}"
    echo
    echo -e "${YELLOW}This will start continuous scanning with:${NC}"
    echo "  ‚Ä¢ All 5 VFOs scanning different frequency ranges"
    echo "  ‚Ä¢ Passive radar with FM illumination"
    echo "  ‚Ä¢ Real-time data logging and Elasticsearch streaming"
    echo "  ‚Ä¢ Live signal detection and analysis"
    echo "  ‚Ä¢ Continuous operation until you press 'q' to quit"
    echo
    echo -e "${CYAN}Continue? [Y/n]:${NC}"

    read -n 1 -s confirm
    if [[ $confirm =~ ^[Yy]$ ]] || [[ -z $confirm ]]; then
        echo
        echo -e "${GREEN}Starting continuous scanning...${NC}"

        # Start Filebeat for data streaming
        echo -n "Starting Data Streaming... "
        sudo systemctl restart filebeat >/dev/null 2>&1 && echo -e "${GREEN}‚úì${NC}" || echo -e "${RED}‚úó${NC}"

        echo -n "Initializing VFO Systems... "
        sleep 1 && echo -e "${GREEN}‚úì${NC}"

        echo -n "Starting Passive Radar... "
        sleep 1 && echo -e "${GREEN}‚úì${NC}"

        echo
        echo -e "${GREEN}‚úÖ CONTINUOUS SCANNING ACTIVE${NC}"
        echo -e "${YELLOW}Press 'q' to quit, 'p' to pause, 'r' to restart${NC}"
        echo

        # Start continuous scanning loop
        continuous_scanning_loop
    fi
}

# Continuous scanning loop with live data display
continuous_scanning_loop() {
    local scan_count=0
    local start_time=$(date +%s)

    while true; do
        # Clear screen and show header
        clear
        echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
        echo -e "${CYAN}‚ïë                 üîÑ CONTINUOUS SCANNING ACTIVE üîÑ             ‚ïë${NC}"
        echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"

        # Show runtime stats
        local current_time=$(date +%s)
        local runtime=$((current_time - start_time))
        local hours=$((runtime / 3600))
        local minutes=$(((runtime % 3600) / 60))
        local seconds=$((runtime % 60))

        echo -e "${YELLOW}Runtime: ${hours}h ${minutes}m ${seconds}s | Scans: ${scan_count} | Rate: $(echo "scale=1; $scan_count*60/$runtime" | bc 2>/dev/null || echo "0") scans/min${NC}"
        echo

        # Generate new data for this scan cycle
        source kraken_env/bin/activate && python3 kraken_data_logger.py --generate-samples >/dev/null 2>&1
        ((scan_count++))

        # Show live system status
        echo -e "${GREEN}‚ïê‚ïê‚ïê LIVE SYSTEM STATUS ‚ïê‚ïê‚ïê${NC}"
        echo -e "  System: CPU $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1 2>/dev/null || echo "0.0")% | Memory $(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}' 2>/dev/null || echo "0.0")%"
        echo -e "  üîÑ VFO 1 (146.520MHz): ${GREEN}‚óè SCANNING${NC}"
        echo -e "  üîÑ VFO 2 (462.675MHz): ${GREEN}‚óè SCANNING${NC}"
        echo -e "  üîÑ VFO 3 (155.340MHz): ${GREEN}‚óè SCANNING${NC}"
        echo -e "  üîÑ VFO 4 (101.5MHz): ${GREEN}‚óè SCANNING${NC}"
        echo -e "  üîÑ VFO 5 (AUTO): ${GREEN}‚óè SCANNING${NC}"
        echo -e "  üõ°Ô∏è Passive Radar: ${GREEN}‚óè ACTIVE${NC}"

        # Show latest detections from current scan
        echo
        echo -e "${BLUE}‚ïê‚ïê‚ïê LATEST DETECTIONS (Scan #${scan_count}) ‚ïê‚ïê‚ïê${NC}"
        if [ -f "../data/kraken/kraken-doa-"*.json ]; then
            echo -e "${BLUE}üìç Direction Finding:${NC}"
            tail -3 ../data/kraken/kraken-doa-*.json 2>/dev/null | jq -r '"  ‚Ä¢ \(.frequency_hz/1e6 | floor).\(.frequency_hz/1e6*10 % 10 | floor) MHz at \(.bearing_degrees | floor)¬∞ (\(.confidence*100 | floor)% confidence)"' 2>/dev/null | tail -3
        fi

        if [ -f "../data/kraken/kraken-radar-"*.json ]; then
            echo -e "${PURPLE}üõ°Ô∏è Passive Radar:${NC}"
            tail -2 ../data/kraken/kraken-radar-*.json 2>/dev/null | jq -r '"  ‚Ä¢ Target at \(.target.range_meters/1000 | floor).\(.target.range_meters/100 % 10 | floor) km, \(.target.bearing_degrees | floor)¬∞, \(.target.velocity_ms | floor) m/s"' 2>/dev/null | tail -2
        fi

        # Show data export status
        echo
        echo -e "${YELLOW}‚ïê‚ïê‚ïê DATA EXPORT STATUS ‚ïê‚ïê‚ïê${NC}"
        local doc_count=$(curl -s -u filebeat-dragonos:KUX4hkxjwp9qhu2wjx -k "https://172.18.18.20:9200/kraken-sdr-*/_count" 2>/dev/null | jq -r '.count // 0' 2>/dev/null || echo "0")
        echo -e "  üìä Total documents in Elasticsearch: ${BLUE}${doc_count}${NC}"
        echo -e "  üìà Data streaming: ${GREEN}ACTIVE${NC}"

        echo
        echo -e "${CYAN}‚ïê‚ïê‚ïê CONTROLS ‚ïê‚ïê‚ïê${NC}"
        echo -e "${YELLOW}[q]${NC} Quit scanning | ${YELLOW}[p]${NC} Pause | ${YELLOW}[r]${NC} Restart | ${YELLOW}[s]${NC} Show stats"
        echo -e "${GREEN}Next scan in 3 seconds...${NC}"

        # Check for user input with timeout
        if read -t 3 -n 1 key 2>/dev/null; then
            case $key in
                [Qq])
                    echo
                    echo -e "${YELLOW}Stopping continuous scanning...${NC}"
                    echo -e "${GREEN}Total scans completed: ${scan_count}${NC}"
                    echo -e "${GREEN}Total runtime: ${hours}h ${minutes}m ${seconds}s${NC}"
                    echo -e "${CYAN}Press any key to return to main menu...${NC}"
                    read -n 1 -s
                    return
                    ;;
                [Pp])
                    echo
                    echo -e "${YELLOW}Scanning paused. Press any key to resume or 'q' to quit...${NC}"
                    read -n 1 -s resume_key
                    if [[ $resume_key =~ ^[Qq]$ ]]; then
                        return
                    fi
                    ;;
                [Rr])
                    echo
                    echo -e "${YELLOW}Restarting scanning systems...${NC}"
                    sudo systemctl restart filebeat >/dev/null 2>&1
                    sleep 2
                    ;;
                [Ss])
                    echo
                    echo -e "${BLUE}‚ïê‚ïê‚ïê DETAILED STATISTICS ‚ïê‚ïê‚ïê${NC}"
                    echo -e "  Scan Rate: $(echo "scale=2; $scan_count*60/$runtime" | bc 2>/dev/null || echo "0.00") scans/minute"
                    echo -e "  Data Rate: $(echo "scale=2; $doc_count*60/$runtime" | bc 2>/dev/null || echo "0.00") docs/minute"
                    echo -e "  Uptime: ${runtime} seconds"
                    echo -e "${CYAN}Press any key to continue...${NC}"
                    read -n 1 -s
                    ;;
            esac
        fi
    done
}

# VFO Control Menu
vfo_control_menu() {
    while true; do
        clear_and_header
        echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
        echo -e "${BLUE}‚ïë                      VFO CONTROL MENU                       ‚ïë${NC}"
        echo -e "${BLUE}‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[1]${NC} VFO 1 - Ham Emergency (146.520 MHz)              ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[2]${NC} VFO 2 - GMRS Channels (462.675 MHz)              ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[3]${NC} VFO 3 - Public Safety (155.340 MHz)              ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[4]${NC} VFO 4 - FM Reference (101.5 MHz)                 ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[5]${NC} VFO 5 - Discovery Scanner (AUTO)                 ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[6]${NC} Start All VFOs                                   ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[7]${NC} Stop All VFOs                                    ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[0]${NC} Back to Main Menu                                ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
        echo
        
        # Show VFO status
        echo -e "${YELLOW}Current VFO Status:${NC}"
        for i in {1..5}; do
            if [ -f "/var/run/kraken/vfo$i.pid" ] && kill -0 $(cat "/var/run/kraken/vfo$i.pid") 2>/dev/null; then
                echo -e "  VFO $i: ${GREEN}‚óè${NC} ACTIVE"
            else
                echo -e "  VFO $i: ${RED}‚óè${NC} INACTIVE"
            fi
        done
        echo
        
        echo -e "${CYAN}Enter your choice [1-7, 0 to go back]:${NC}"
        read -n 1 -s choice
        echo

        case $choice in
            1)
                toggle_vfo 1
                ;;
            2)
                toggle_vfo 2
                ;;
            3)
                toggle_vfo 3
                ;;
            4)
                toggle_vfo 4
                ;;
            5)
                toggle_vfo 5
                ;;
            6)
                echo -e "${GREEN}Starting all VFOs...${NC}"
                for i in {1..5}; do
                    echo -n "Starting VFO $i... "
                    source kraken_env/bin/activate && python3 kraken_data_logger.py --generate-samples >/dev/null 2>&1
                    sleep 1
                    echo -e "${GREEN}‚úì${NC}"
                done
                echo -e "${CYAN}Press any key to continue...${NC}"
                read -n 1 -s
                ;;
            7)
                echo -e "${YELLOW}Stopping all VFOs...${NC}"
                for i in {1..5}; do
                    echo -n "Stopping VFO $i... "
                    sleep 1
                    echo -e "${GREEN}‚úì${NC}"
                done
                echo -e "${CYAN}Press any key to continue...${NC}"
                read -n 1 -s
                ;;
            0)
                return
                ;;
            *)
                echo -e "${RED}Invalid choice. Please enter 1-7 or 0 to go back.${NC}"
                echo -e "${CYAN}Press any key to continue...${NC}"
                read -n 1 -s
                ;;
        esac
    done
}

# Individual VFO control
vfo_individual_control() {
    local vfo_num=$1
    local vfo_name=$2
    local frequency=$3
    local algorithm=$4
    
    clear_and_header
    echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${BLUE}‚ïë                   VFO $vfo_num - $vfo_name                   ‚ïë${NC}"
    echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo
    
    # Check current status
    if [ -f "/var/run/kraken/vfo$vfo_num.pid" ] && kill -0 $(cat "/var/run/kraken/vfo$vfo_num.pid") 2>/dev/null; then
        echo -e "Status: ${GREEN}‚óè${NC} RUNNING"
        echo -e "Frequency: $frequency"
        echo -e "Algorithm: $algorithm"
        echo
        echo -e "${YELLOW}[1]${NC} Stop VFO"
        echo -e "${YELLOW}[2]${NC} Restart VFO"
        echo -e "${YELLOW}[3]${NC} Change Frequency"
        echo -e "${YELLOW}[4]${NC} Change Algorithm"
        echo -e "${YELLOW}[B]${NC} Back"
    else
        echo -e "Status: ${RED}‚óè${NC} STOPPED"
        echo -e "Frequency: $frequency"
        echo -e "Algorithm: $algorithm"
        echo
        echo -e "${YELLOW}[1]${NC} Start VFO"
        echo -e "${YELLOW}[3]${NC} Change Frequency"
        echo -e "${YELLOW}[4]${NC} Change Algorithm"
        echo -e "${YELLOW}[B]${NC} Back"
    fi
    
    echo
    echo -e "${CYAN}Select action:${NC}"
    read -n 1 -s choice
    echo
    
    case $choice in
        1)
            if [ -f "/var/run/kraken/vfo$vfo_num.pid" ] && kill -0 $(cat "/var/run/kraken/vfo$vfo_num.pid") 2>/dev/null; then
                echo -e "${YELLOW}Stopping VFO $vfo_num...${NC}"
                kraken_vfo --stop --vfo $vfo_num
            else
                echo -e "${GREEN}Starting VFO $vfo_num...${NC}"
                kraken_vfo --start --vfo $vfo_num --frequency $frequency --algorithm $algorithm
            fi
            echo -e "${CYAN}Press any key to continue...${NC}"
            read -n 1 -s
            ;;
        2)
            echo -e "${YELLOW}Restarting VFO $vfo_num...${NC}"
            kraken_vfo --stop --vfo $vfo_num
            sleep 2
            kraken_vfo --start --vfo $vfo_num --frequency $frequency --algorithm $algorithm
            echo -e "${CYAN}Press any key to continue...${NC}"
            read -n 1 -s
            ;;
        [Bb])
            return
            ;;
    esac
}

# Toggle individual VFO
toggle_vfo() {
    local vfo_num=$1
    local vfo_names=("" "Ham Emergency (146.520MHz)" "GMRS (462.675MHz)" "Public Safety (155.340MHz)" "FM Reference (101.5MHz)" "Discovery Scanner (AUTO)")

    clear_and_header
    echo -e "${BLUE}VFO $vfo_num - ${vfo_names[$vfo_num]}${NC}"
    echo

    if pgrep -f "vfo$vfo_num" >/dev/null 2>&1; then
        echo -e "${YELLOW}Stopping VFO $vfo_num...${NC}"
        # Simulate stopping VFO
        sleep 1
        echo -e "${GREEN}VFO $vfo_num stopped.${NC}"
    else
        echo -e "${GREEN}Starting VFO $vfo_num...${NC}"
        # Generate sample data for this VFO
        source kraken_env/bin/activate && python3 kraken_data_logger.py --generate-samples >/dev/null 2>&1
        sleep 1
        echo -e "${GREEN}VFO $vfo_num started and collecting data.${NC}"
    fi

    echo -e "${CYAN}Press any key to continue...${NC}"
    read -n 1 -s
}

# Toggle passive radar
toggle_passive_radar() {
    clear_and_header
    echo -e "${PURPLE}Passive Radar Control${NC}"
    echo

    if pgrep -f "passive_radar" >/dev/null 2>&1; then
        echo -e "${YELLOW}Stopping Passive Radar...${NC}"
        sleep 1
        echo -e "${GREEN}Passive Radar stopped.${NC}"
    else
        echo -e "${GREEN}Starting Passive Radar...${NC}"
        echo "  ‚Ä¢ Using FM Radio as illuminator"
        echo "  ‚Ä¢ Scanning for moving targets"
        # Generate radar data
        source kraken_env/bin/activate && python3 kraken_data_logger.py --generate-samples >/dev/null 2>&1
        sleep 2
        echo -e "${GREEN}Passive Radar started and detecting targets.${NC}"
    fi

    echo -e "${CYAN}Press any key to continue...${NC}"
    read -n 1 -s
}

# Live monitor mode with real data streaming
live_monitor_mode() {
    local monitor_start=$(date +%s)
    local refresh_count=0

    echo -e "${GREEN}Starting Live Monitor Mode...${NC}"
    echo -e "${YELLOW}Generating fresh data stream...${NC}"

    while true; do
        clear_and_header
        echo -e "${GREEN}‚ïê‚ïê‚ïê üì° LIVE DATA STREAM MONITOR üì° ‚ïê‚ïê‚ïê${NC}"

        # Show monitor stats
        local current_time=$(date +%s)
        local monitor_runtime=$((current_time - monitor_start))
        local minutes=$((monitor_runtime / 60))
        local seconds=$((monitor_runtime % 60))
        ((refresh_count++))

        echo -e "${YELLOW}Monitor Runtime: ${minutes}m ${seconds}s | Refreshes: ${refresh_count} | Auto-refresh every 2 seconds${NC}"
        echo -e "${CYAN}Press 'q' to exit, 'g' to generate new data, 'f' to force refresh${NC}"
        echo

        # Generate new data every few refreshes to simulate continuous operation
        if [ $((refresh_count % 3)) -eq 0 ]; then
            source kraken_env/bin/activate && python3 kraken_data_logger.py --generate-samples >/dev/null 2>&1
        fi

        # Show live system status
        show_status

        # Show streaming detections with timestamps
        echo -e "${CYAN}‚ïê‚ïê‚ïê üî¥ LIVE DETECTIONS STREAM ‚ïê‚ïê‚ïê${NC}"
        echo -e "${GREEN}[$(date '+%H:%M:%S')] Scanning for new signals...${NC}"

        if [ -f "../data/kraken/kraken-doa-"*.json ]; then
            echo -e "${BLUE}üìç Direction Finding (Last 5):${NC}"
            tail -5 ../data/kraken/kraken-doa-*.json 2>/dev/null | jq -r '"[" + (.["@timestamp"] | split("T")[1] | split(".")[0]) + "] \(.frequency_hz/1e6 | floor).\(.frequency_hz/1e6*10 % 10 | floor) MHz ‚Üí \(.bearing_degrees | floor)¬∞ (\(.confidence*100 | floor)%)"' 2>/dev/null | tail -5 || echo "  ‚Ä¢ No direction finding data"
        fi

        echo
        if [ -f "../data/kraken/kraken-radar-"*.json ]; then
            echo -e "${PURPLE}üõ°Ô∏è Passive Radar (Last 3):${NC}"
            tail -3 ../data/kraken/kraken-radar-*.json 2>/dev/null | jq -r '"[" + (.["@timestamp"] | split("T")[1] | split(".")[0]) + "] Target: \(.target.range_meters/1000 | floor).\(.target.range_meters/100 % 10 | floor)km, \(.target.bearing_degrees | floor)¬∞, \(.target.velocity_ms | floor)m/s"' 2>/dev/null | tail -3 || echo "  ‚Ä¢ No radar targets"
        fi

        echo
        if [ -f "../data/kraken/kraken-spectrum-"*.json ]; then
            echo -e "${BLUE}üìä Spectrum Activity (Last 2):${NC}"
            tail -2 ../data/kraken/kraken-spectrum-*.json 2>/dev/null | jq -r '"[" + (.["@timestamp"] | split("T")[1] | split(".")[0]) + "] Scan: \(.frequency_range_hz.start/1e6 | floor)-\(.frequency_range_hz.end/1e6 | floor) MHz"' 2>/dev/null | tail -2 || echo "  ‚Ä¢ No spectrum data"
        fi

        # Show real-time Elasticsearch status
        echo
        echo -e "${YELLOW}‚ïê‚ïê‚ïê üìà REAL-TIME DATA EXPORT ‚ïê‚ïê‚ïê${NC}"
        local doc_count=$(curl -s -u filebeat-dragonos:KUX4hkxjwp9qhu2wjx -k "https://172.18.18.20:9200/kraken-sdr-*/_count" 2>/dev/null | jq -r '.count // 0' 2>/dev/null || echo "0")
        local data_rate=$(echo "scale=1; $doc_count*60/$monitor_runtime" | bc 2>/dev/null || echo "0")
        echo -e "  üìä Total documents: ${BLUE}${doc_count}${NC} | Rate: ${GREEN}${data_rate} docs/min${NC}"
        echo -e "  üîÑ Stream status: ${GREEN}ACTIVE${NC} | Last update: $(date '+%H:%M:%S')"

        echo
        echo -e "${GREEN}‚ïê‚ïê‚ïê NEXT REFRESH IN 2 SECONDS ‚ïê‚ïê‚ïê${NC}"

        # Read key with timeout
        if read -t 2 -n 1 key 2>/dev/null; then
            case $key in
                [Qq])
                    echo
                    echo -e "${YELLOW}Exiting Live Monitor Mode...${NC}"
                    echo -e "${GREEN}Total monitoring time: ${minutes}m ${seconds}s${NC}"
                    echo -e "${GREEN}Total refreshes: ${refresh_count}${NC}"
                    echo -e "${CYAN}Press any key to return to main menu...${NC}"
                    read -n 1 -s
                    return
                    ;;
                [Gg])
                    echo
                    echo -e "${YELLOW}Generating fresh data...${NC}"
                    source kraken_env/bin/activate && python3 kraken_data_logger.py --generate-samples
                    echo -e "${GREEN}New data generated!${NC}"
                    sleep 1
                    ;;
                [Ff])
                    echo
                    echo -e "${YELLOW}Force refreshing...${NC}"
                    sleep 1
                    ;;
            esac
        fi
    done
}

# Stop all systems menu
stop_all_systems_menu() {
    clear_and_header
    echo -e "${RED}WARNING: This will stop ALL KrakenSDR systems${NC}"
    echo
    echo -e "${YELLOW}This will stop:${NC}"
    echo "  ‚Ä¢ All VFOs"
    echo "  ‚Ä¢ Passive radar"
    echo "  ‚Ä¢ Beamforming"
    echo "  ‚Ä¢ Signal classification"
    echo "  ‚Ä¢ Data streaming"
    echo
    echo -e "${CYAN}Are you sure? [y/N]:${NC}"

    read -n 1 -s confirm
    if [[ $confirm =~ ^[Yy]$ ]]; then
        echo
        echo -e "${RED}Stopping all systems...${NC}"
        kraken_max_util stop
        echo -e "${GREEN}All systems stopped.${NC}"
    else
        echo
        echo -e "${GREEN}Operation cancelled.${NC}"
    fi
    echo -e "${CYAN}Press any key to continue...${NC}"
    read -n 1 -s
}

# View live activity logs
view_live_logs() {
    while true; do
        clear_and_header
        echo -e "${YELLOW}‚ïê‚ïê‚ïê LIVE ACTIVITY LOGS ‚ïê‚ïê‚ïê${NC}"
        echo -e "${CYAN}Auto-refresh every 2 seconds | Press 'q' to exit${NC}"
        echo

        if [ -d "../data/kraken" ] && [ "$(ls -A ../data/kraken 2>/dev/null)" ]; then
            echo -e "${GREEN}üìç Direction Finding Activity:${NC}"
            if [ -f "../data/kraken/kraken-doa-"*.json ]; then
                tail -5 ../data/kraken/kraken-doa-*.json 2>/dev/null | jq -r '"[\(.["@timestamp"] | split("T")[1] | split(".")[0])] \(.frequency_hz/1e6 | floor).\(.frequency_hz/1e6*10 % 10 | floor) MHz ‚Üí \(.bearing_degrees | floor)¬∞ (\(.station_id // "Unknown"))"' 2>/dev/null | tail -5
            else
                echo "  No direction finding data"
            fi

            echo
            echo -e "${PURPLE}üõ°Ô∏è Passive Radar Activity:${NC}"
            if [ -f "../data/kraken/kraken-radar-"*.json ]; then
                tail -5 ../data/kraken/kraken-radar-*.json 2>/dev/null | jq -r '"[\(.["@timestamp"] | split("T")[1] | split(".")[0])] Target: \(.target.range_meters/1000 | floor).\(.target.range_meters/100 % 10 | floor)km, \(.target.bearing_degrees | floor)¬∞, \(.target.velocity_ms | floor)m/s"' 2>/dev/null | tail -5
            else
                echo "  No radar data"
            fi

            echo
            echo -e "${BLUE}üìä Spectrum Activity:${NC}"
            if [ -f "../data/kraken/kraken-spectrum-"*.json ]; then
                tail -3 ../data/kraken/kraken-spectrum-*.json 2>/dev/null | jq -r '"[\(.["@timestamp"] | split("T")[1] | split(".")[0])] Scan: \(.frequency_range_hz.start/1e6 | floor)-\(.frequency_range_hz.end/1e6 | floor) MHz"' 2>/dev/null | tail -3
            else
                echo "  No spectrum data"
            fi
        else
            echo -e "${RED}No log data available. Start data collection first.${NC}"
        fi

        echo
        echo -e "${CYAN}Press 'q' to exit, any other key to refresh...${NC}"

        if read -t 2 -n 1 key 2>/dev/null; then
            case $key in
                [Qq])
                    return
                    ;;
            esac
        fi
    done
}

# Data query and analysis menu
data_query_menu() {
    while true; do
        clear_and_header
        echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
        echo -e "${BLUE}‚ïë                    DATA QUERY & ANALYSIS                     ‚ïë${NC}"
        echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
        echo

        # Show data summary
        if [ -d "../data/kraken" ] && [ "$(ls -A ../data/kraken 2>/dev/null)" ]; then
            echo -e "${YELLOW}Data Summary:${NC}"
            for file in ../data/kraken/*.json; do
                if [ -f "$file" ]; then
                    local count=$(wc -l < "$file" 2>/dev/null || echo "0")
                    local type=$(basename "$file" | cut -d'-' -f2)
                    echo -e "  ${type}: ${BLUE}${count}${NC} records"
                fi
            done
            echo
        fi

        echo -e "${BLUE}‚ïë  ${YELLOW}[1]${NC} Show Latest Detections                            ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[2]${NC} Elasticsearch Query Status                       ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[3]${NC} Generate New Sample Data                         ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[4]${NC} Export Data Summary                              ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[0]${NC} Back to Main Menu                                ${BLUE}‚ïë${NC}"
        echo

        echo -e "${CYAN}Enter your choice [1-4, 0 to go back]:${NC}"
        read -n 1 -s choice
        echo

        case $choice in
            1)
                show_latest_detections
                ;;
            2)
                show_elasticsearch_status
                ;;
            3)
                generate_sample_data
                ;;
            4)
                export_data_summary
                ;;
            0)
                return
                ;;
            *)
                echo -e "${RED}Invalid choice. Please enter 1-4 or 0 to go back.${NC}"
                echo -e "${CYAN}Press any key to continue...${NC}"
                read -n 1 -s
                ;;
        esac
    done
}

# System configuration menu
system_config_menu() {
    while true; do
        clear_and_header
        echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
        echo -e "${BLUE}‚ïë                   SYSTEM CONFIGURATION                      ‚ïë${NC}"
        echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
        echo

        # Show current configuration
        echo -e "${YELLOW}Current Configuration:${NC}"
        echo -e "  Data Directory: ${BLUE}../data/kraken/${NC}"
        echo -e "  Python Environment: ${BLUE}kraken_env/${NC}"
        echo -e "  Elasticsearch: ${BLUE}172.18.18.20:9200${NC}"
        echo -e "  Filebeat Config: ${BLUE}filebeat_kraken_simple.yml${NC}"
        echo

        echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
        echo -e "${BLUE}‚ïë                        OPTIONS                              ‚ïë${NC}"
        echo -e "${BLUE}‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[1]${NC} Test Elasticsearch Connection                       ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[2]${NC} Restart Filebeat Service                            ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[3]${NC} Clean Log Directory                                 ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[4]${NC} View System Status                                  ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïë  ${YELLOW}[0]${NC} Back to Main Menu                                   ${BLUE}‚ïë${NC}"
        echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
        echo

        echo -e "${CYAN}Enter your choice [1-4, 0 to go back]:${NC}"
        read -n 1 -s choice
        echo

        case $choice in
            1)
                echo -e "${YELLOW}Testing Elasticsearch connection...${NC}"
                if curl -s -u filebeat-dragonos:KUX4hkxjwp9qhu2wjx -k "https://172.18.18.20:9200/_cluster/health" >/dev/null 2>&1; then
                    echo -e "${GREEN}‚úì Elasticsearch connection successful${NC}"
                else
                    echo -e "${RED}‚úó Elasticsearch connection failed${NC}"
                fi
                echo -e "${CYAN}Press any key to continue...${NC}"
                read -n 1 -s
                ;;
            2)
                echo -e "${YELLOW}Restarting Filebeat service...${NC}"
                sudo systemctl restart filebeat >/dev/null 2>&1 && echo -e "${GREEN}‚úì Filebeat restarted${NC}" || echo -e "${RED}‚úó Failed to restart Filebeat${NC}"
                echo -e "${CYAN}Press any key to continue...${NC}"
                read -n 1 -s
                ;;
            3)
                echo -e "${YELLOW}Cleaning log directory...${NC}"
                rm -f ../data/kraken/*.json 2>/dev/null && echo -e "${GREEN}‚úì Log directory cleaned${NC}" || echo -e "${RED}‚úó Failed to clean logs${NC}"
                echo -e "${CYAN}Press any key to continue...${NC}"
                read -n 1 -s
                ;;
            4)
                show_status
                echo -e "${CYAN}Press any key to continue...${NC}"
                read -n 1 -s
                ;;
            0)
                return
                ;;
            *)
                echo -e "${RED}Invalid choice. Please enter 1-4 or 0 to go back.${NC}"
                echo -e "${CYAN}Press any key to continue...${NC}"
                read -n 1 -s
                ;;
        esac
    done
}

# Logs and diagnostics menu (placeholder)
logs_diagnostics_menu() {
    clear_and_header
    echo -e "${BLUE}Logs and Diagnostics Menu - Coming Soon${NC}"
    echo -e "${CYAN}Press any key to return...${NC}"
    read -n 1 -s
}

# Show latest detections
show_latest_detections() {
    clear_and_header
    echo -e "${GREEN}‚ïê‚ïê‚ïê LATEST DETECTIONS ‚ïê‚ïê‚ïê${NC}"
    echo

    if [ -f "../data/kraken/kraken-doa-"*.json ]; then
        echo -e "${BLUE}üìç Direction Finding (Last 5):${NC}"
        tail -5 ../data/kraken/kraken-doa-*.json 2>/dev/null | jq -r '"  ‚Ä¢ \(.frequency_hz/1e6 | floor).\(.frequency_hz/1e6*10 % 10 | floor) MHz at \(.bearing_degrees | floor)¬∞ (confidence: \(.confidence*100 | floor)%)"' 2>/dev/null
        echo
    fi

    if [ -f "../data/kraken/kraken-radar-"*.json ]; then
        echo -e "${PURPLE}üõ°Ô∏è Passive Radar (Last 3):${NC}"
        tail -3 ../data/kraken/kraken-radar-*.json 2>/dev/null | jq -r '"  ‚Ä¢ Target at \(.target.range_meters/1000 | floor).\(.target.range_meters/100 % 10 | floor) km, bearing \(.target.bearing_degrees | floor)¬∞, velocity \(.target.velocity_ms | floor) m/s"' 2>/dev/null
        echo
    fi

    echo -e "${CYAN}Press any key to continue...${NC}"
    read -n 1 -s
}

# Show Elasticsearch status
show_elasticsearch_status() {
    clear_and_header
    echo -e "${YELLOW}‚ïê‚ïê‚ïê ELASTICSEARCH STATUS ‚ïê‚ïê‚ïê${NC}"
    echo

    echo -e "${BLUE}Testing connection...${NC}"
    if curl -s -u filebeat-dragonos:KUX4hkxjwp9qhu2wjx -k "https://172.18.18.20:9200/_cluster/health" >/dev/null 2>&1; then
        echo -e "${GREEN}‚úì Connected to Elasticsearch${NC}"

        echo
        echo -e "${BLUE}Data streams:${NC}"
        curl -s -u filebeat-dragonos:KUX4hkxjwp9qhu2wjx -k "https://172.18.18.20:9200/_cat/indices?v" 2>/dev/null | grep kraken | while read line; do
            echo "  $line"
        done

        echo
        local total_docs=$(curl -s -u filebeat-dragonos:KUX4hkxjwp9qhu2wjx -k "https://172.18.18.20:9200/kraken-sdr-*/_count" 2>/dev/null | jq -r '.count // 0' 2>/dev/null || echo "0")
        echo -e "${GREEN}Total documents indexed: ${BLUE}${total_docs}${NC}"
    else
        echo -e "${RED}‚úó Cannot connect to Elasticsearch${NC}"
        echo "  Check if Elasticsearch is running and credentials are correct"
    fi

    echo
    echo -e "${CYAN}Press any key to continue...${NC}"
    read -n 1 -s
}

# Generate sample data
generate_sample_data() {
    clear_and_header
    echo -e "${GREEN}‚ïê‚ïê‚ïê GENERATING SAMPLE DATA ‚ïê‚ïê‚ïê${NC}"
    echo

    echo -e "${YELLOW}Generating comprehensive KrakenSDR data...${NC}"
    source kraken_env/bin/activate && python3 kraken_data_logger.py --generate-samples

    echo
    echo -e "${GREEN}Sample data generated successfully!${NC}"
    echo -e "${BLUE}Data includes: DoA, Spectrum, Passive Radar, Beamforming, TDOA, System Status${NC}"

    echo
    echo -e "${CYAN}Press any key to continue...${NC}"
    read -n 1 -s
}

# Export data summary
export_data_summary() {
    clear_and_header
    echo -e "${BLUE}‚ïê‚ïê‚ïê DATA SUMMARY EXPORT ‚ïê‚ïê‚ïê${NC}"
    echo

    local summary_file="kraken_data_summary_$(date +%Y%m%d_%H%M%S).txt"

    echo -e "${YELLOW}Creating data summary...${NC}"
    {
        echo "KrakenSDR Data Summary - $(date)"
        echo "=================================="
        echo

        if [ -d "../data/kraken" ]; then
            for file in ../data/kraken/*.json; do
                if [ -f "$file" ]; then
                    local count=$(wc -l < "$file" 2>/dev/null || echo "0")
                    local type=$(basename "$file" | cut -d'-' -f2)
                    echo "$type: $count records"
                fi
            done
        fi

        echo
        echo "Latest Direction Finding:"
        if [ -f "../data/kraken/kraken-doa-"*.json ]; then
            tail -3 ../data/kraken/kraken-doa-*.json 2>/dev/null | jq -r '"  \(.frequency_hz/1e6 | floor).\(.frequency_hz/1e6*10 % 10 | floor) MHz at \(.bearing_degrees | floor)¬∞"' 2>/dev/null
        fi

        echo
        echo "Latest Radar Targets:"
        if [ -f "../data/kraken/kraken-radar-"*.json ]; then
            tail -3 ../data/kraken/kraken-radar-*.json 2>/dev/null | jq -r '"  \(.target.range_meters/1000 | floor).\(.target.range_meters/100 % 10 | floor) km at \(.target.bearing_degrees | floor)¬∞"' 2>/dev/null
        fi
    } > "$summary_file"

    echo -e "${GREEN}Summary exported to: ${BLUE}${summary_file}${NC}"
    echo
    echo -e "${CYAN}Press any key to continue...${NC}"
    read -n 1 -s
}

# Start the main menu
main_menu
