#!/bin/bash
# KrakenSDR Elasticsearch Integration Script
# Location: /usr/local/bin/kraken_elasticsearch

KRAKEN_PID="/var/run/kraken"
KRAKEN_LOG="/var/log/kraken"
KRAKEN_CONFIG="/etc/kraken"
ES_HOST="localhost:9200"
ES_INDEX_PREFIX="kraken-sdr"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# Log function
log_elasticsearch() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ES: $1" >> $KRAKEN_LOG/elasticsearch.log
}

# Check if Elasticsearch is running
is_elasticsearch_running() {
    local pidfile="$KRAKEN_PID/elasticsearch.pid"
    if [ -f "$pidfile" ]; then
        local pid=$(cat "$pidfile")
        if kill -0 "$pid" 2>/dev/null; then
            return 0
        else
            rm -f "$pidfile"
            return 1
        fi
    fi
    return 1
}

# Check Elasticsearch connectivity
check_elasticsearch_connection() {
    if curl -s "http://$ES_HOST/_cluster/health" >/dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# Create Elasticsearch indices and mappings
setup_elasticsearch_indices() {
    echo -e "${BLUE}Setting up Elasticsearch indices...${NC}"
    
    # Check connection first
    if ! check_elasticsearch_connection; then
        echo -e "${RED}Cannot connect to Elasticsearch at $ES_HOST${NC}"
        return 1
    fi
    
    # Create indices for different data types
    local indices=("spectrum" "direction-finding" "passive-radar" "signal-classification" "system-status")
    
    for index in "${indices[@]}"; do
        local full_index="${ES_INDEX_PREFIX}-${index}-$(date +%Y.%m)"
        
        echo -n "Creating index $full_index... "
        
        # Create index with mapping
        if curl -s -X PUT "http://$ES_HOST/$full_index" \
            -H 'Content-Type: application/json' \
            -d @$KRAKEN_CONFIG/elasticsearch_mapping.json >/dev/null 2>&1; then
            echo -e "${GREEN}✓${NC}"
            log_elasticsearch "Created index: $full_index"
        else
            echo -e "${YELLOW}exists${NC}"
        fi
    done
    
    # Create index templates
    echo -n "Creating index template... "
    if curl -s -X PUT "http://$ES_HOST/_template/kraken-template" \
        -H 'Content-Type: application/json' \
        -d '{
            "index_patterns": ["kraken-sdr-*"],
            "settings": {
                "number_of_shards": 1,
                "number_of_replicas": 0,
                "refresh_interval": "5s"
            }
        }' >/dev/null 2>&1; then
        echo -e "${GREEN}✓${NC}"
        log_elasticsearch "Created index template"
    else
        echo -e "${RED}✗${NC}"
        log_elasticsearch "Failed to create index template"
    fi
}

# Start Elasticsearch data streamer
start_elasticsearch_streamer() {
    local mode=${1:-"REAL_TIME"}
    local bulk_size=${2:-"100"}
    local flush_interval=${3:-"5"}
    
    echo -e "${GREEN}Starting Elasticsearch Data Streamer...${NC}"
    echo -e "  Mode: ${BLUE}$mode${NC}"
    echo -e "  Bulk Size: ${BLUE}$bulk_size${NC}"
    echo -e "  Flush Interval: ${BLUE}${flush_interval}s${NC}"
    
    # Check if already running
    if is_elasticsearch_running; then
        echo -e "${YELLOW}Elasticsearch streamer is already running${NC}"
        return 1
    fi
    
    # Check Elasticsearch connection
    if ! check_elasticsearch_connection; then
        echo -e "${RED}Cannot connect to Elasticsearch at $ES_HOST${NC}"
        echo -e "${YELLOW}Please ensure Elasticsearch is running and accessible${NC}"
        return 1
    fi
    
    # Setup indices
    setup_elasticsearch_indices
    
    # Create directories if they don't exist
    mkdir -p $KRAKEN_PID $KRAKEN_LOG
    
    # Start the Elasticsearch streamer process
    if python3 /home/pi/krakensdr_doa/scripts/elasticsearch_streamer.py \
        --host $ES_HOST \
        --index-prefix $ES_INDEX_PREFIX \
        --mode $mode \
        --bulk-size $bulk_size \
        --flush-interval $flush_interval \
        --daemon \
        --pidfile $KRAKEN_PID/elasticsearch.pid \
        --logfile $KRAKEN_LOG/elasticsearch_streamer.log 2>/dev/null; then
        echo -e "${GREEN}Elasticsearch streamer started successfully${NC}"
        log_elasticsearch "Elasticsearch streamer started - Mode: $mode"
        return 0
    else
        echo -e "${RED}Failed to start Elasticsearch streamer${NC}"
        log_elasticsearch "Failed to start Elasticsearch streamer"
        return 1
    fi
}

# Stop Elasticsearch streamer
stop_elasticsearch_streamer() {
    echo -e "${YELLOW}Stopping Elasticsearch Data Streamer...${NC}"
    
    if ! is_elasticsearch_running; then
        echo -e "${YELLOW}Elasticsearch streamer is not running${NC}"
        return 1
    fi
    
    local pidfile="$KRAKEN_PID/elasticsearch.pid"
    local pid=$(cat "$pidfile")
    
    # Send TERM signal first
    if kill -TERM "$pid" 2>/dev/null; then
        # Wait for graceful shutdown
        local count=0
        while kill -0 "$pid" 2>/dev/null && [ $count -lt 10 ]; do
            sleep 1
            ((count++))
        done
        
        # Force kill if still running
        if kill -0 "$pid" 2>/dev/null; then
            kill -KILL "$pid" 2>/dev/null
        fi
        
        rm -f "$pidfile"
        echo -e "${GREEN}Elasticsearch streamer stopped successfully${NC}"
        log_elasticsearch "Elasticsearch streamer stopped"
        return 0
    else
        echo -e "${RED}Failed to stop Elasticsearch streamer${NC}"
        rm -f "$pidfile"
        return 1
    fi
}

# Show Elasticsearch status
show_elasticsearch_status() {
    echo -e "${BLUE}Elasticsearch Integration Status${NC}"
    echo "================================="
    
    # Check Elasticsearch connection
    if check_elasticsearch_connection; then
        echo -e "Elasticsearch Server: ${GREEN}●${NC} CONNECTED ($ES_HOST)"
        
        # Get cluster health
        local health=$(curl -s "http://$ES_HOST/_cluster/health" | jq -r '.status' 2>/dev/null || echo "unknown")
        case $health in
            "green")
                echo -e "Cluster Health: ${GREEN}●${NC} GREEN"
                ;;
            "yellow")
                echo -e "Cluster Health: ${YELLOW}●${NC} YELLOW"
                ;;
            "red")
                echo -e "Cluster Health: ${RED}●${NC} RED"
                ;;
            *)
                echo -e "Cluster Health: ${BLUE}●${NC} UNKNOWN"
                ;;
        esac
    else
        echo -e "Elasticsearch Server: ${RED}●${NC} DISCONNECTED ($ES_HOST)"
    fi
    
    # Check streamer process
    if is_elasticsearch_running; then
        echo -e "Data Streamer: ${GREEN}●${NC} RUNNING"
        local pid=$(cat "$KRAKEN_PID/elasticsearch.pid")
        echo -e "PID: ${BLUE}$pid${NC}"
        
        # Show process info
        if ps -p $pid -o pid,ppid,pcpu,pmem,etime,cmd --no-headers 2>/dev/null; then
            echo
        fi
    else
        echo -e "Data Streamer: ${RED}●${NC} STOPPED"
    fi
    
    # Show index statistics
    if check_elasticsearch_connection; then
        echo
        echo -e "${YELLOW}Index Statistics:${NC}"
        
        # Get document counts for each index
        local indices=$(curl -s "http://$ES_HOST/_cat/indices/${ES_INDEX_PREFIX}-*?h=index,docs.count" 2>/dev/null)
        if [ -n "$indices" ]; then
            echo "$indices" | while read index count; do
                echo -e "  ${BLUE}$index${NC}: $count documents"
            done
        else
            echo -e "  ${YELLOW}No KrakenSDR indices found${NC}"
        fi
        
        # Show recent indexing rate
        local total_docs=$(curl -s "http://$ES_HOST/${ES_INDEX_PREFIX}-*/_count" 2>/dev/null | jq -r '.count // 0' 2>/dev/null || echo "0")
        echo -e "  ${CYAN}Total Documents${NC}: $total_docs"
    fi
    
    # Show recent log entries
    if [ -f "$KRAKEN_LOG/elasticsearch_streamer.log" ]; then
        echo
        echo -e "${YELLOW}Recent Activity:${NC}"
        tail -5 "$KRAKEN_LOG/elasticsearch_streamer.log" 2>/dev/null | while read line; do
            echo "  $line"
        done
    fi
}

# Query Elasticsearch data
query_elasticsearch() {
    local query_type=${1:-"recent"}
    local limit=${2:-"10"}
    
    if ! check_elasticsearch_connection; then
        echo -e "${RED}Cannot connect to Elasticsearch${NC}"
        return 1
    fi
    
    echo -e "${BLUE}Querying Elasticsearch Data...${NC}"
    echo
    
    case $query_type in
        "recent")
            echo -e "${YELLOW}Recent Documents (last $limit):${NC}"
            curl -s "http://$ES_HOST/${ES_INDEX_PREFIX}-*/_search" \
                -H 'Content-Type: application/json' \
                -d "{
                    \"size\": $limit,
                    \"sort\": [{\"timestamp\": {\"order\": \"desc\"}}],
                    \"_source\": [\"timestamp\", \"device_id\", \"frequency\", \"signal.power\", \"direction_finding.bearing\"]
                }" | jq -r '.hits.hits[]._source | "\(.timestamp) - \(.device_id) - \(.frequency)Hz - \(.signal.power)dBm - \(.direction_finding.bearing)°"' 2>/dev/null
            ;;
        "signals")
            echo -e "${YELLOW}Active Signals:${NC}"
            curl -s "http://$ES_HOST/${ES_INDEX_PREFIX}-*/_search" \
                -H 'Content-Type: application/json' \
                -d '{
                    "size": 0,
                    "aggs": {
                        "frequencies": {
                            "terms": {
                                "field": "frequency",
                                "size": 20
                            }
                        }
                    }
                }' | jq -r '.aggregations.frequencies.buckets[] | "\(.key)Hz - \(.doc_count) detections"' 2>/dev/null
            ;;
        "bearings")
            echo -e "${YELLOW}Direction Finding Results:${NC}"
            curl -s "http://$ES_HOST/${ES_INDEX_PREFIX}-direction-finding-*/_search" \
                -H 'Content-Type: application/json' \
                -d "{
                    \"size\": $limit,
                    \"sort\": [{\"timestamp\": {\"order\": \"desc\"}}],
                    \"_source\": [\"timestamp\", \"frequency\", \"direction_finding.bearing\", \"direction_finding.confidence\"]
                }" | jq -r '.hits.hits[]._source | "\(.timestamp) - \(.frequency)Hz - \(.direction_finding.bearing)° (\(.direction_finding.confidence))"' 2>/dev/null
            ;;
        "targets")
            echo -e "${YELLOW}Passive Radar Targets:${NC}"
            curl -s "http://$ES_HOST/${ES_INDEX_PREFIX}-passive-radar-*/_search" \
                -H 'Content-Type: application/json' \
                -d "{
                    \"size\": $limit,
                    \"sort\": [{\"timestamp\": {\"order\": \"desc\"}}],
                    \"_source\": [\"timestamp\", \"passive_radar.target_id\", \"passive_radar.range\", \"passive_radar.velocity\"]
                }" | jq -r '.hits.hits[]._source | "\(.timestamp) - \(.passive_radar.target_id) - \(.passive_radar.range)m - \(.passive_radar.velocity)m/s"' 2>/dev/null
            ;;
    esac
}

# Show usage
show_usage() {
    echo "Usage: $0 [OPTIONS] COMMAND"
    echo
    echo "Commands:"
    echo "  --start [--mode MODE] [--bulk-size SIZE] [--flush-interval SEC]"
    echo "  --stop"
    echo "  --restart"
    echo "  --status"
    echo "  --setup-indices"
    echo "  --query [--type TYPE] [--limit N]"
    echo "  --test-connection"
    echo
    echo "Options:"
    echo "  --mode MODE           Streaming mode (REAL_TIME, BATCH, TEST)"
    echo "  --bulk-size SIZE      Bulk indexing size (default: 100)"
    echo "  --flush-interval SEC  Flush interval in seconds (default: 5)"
    echo "  --type TYPE           Query type (recent, signals, bearings, targets)"
    echo "  --limit N             Limit results (default: 10)"
    echo "  --host HOST:PORT      Elasticsearch host (default: localhost:9200)"
    echo
    echo "Examples:"
    echo "  $0 --start"
    echo "  $0 --start --mode REAL_TIME --bulk-size 50"
    echo "  $0 --status"
    echo "  $0 --query --type recent --limit 20"
    echo "  $0 --query --type bearings"
    echo "  $0 --setup-indices"
}

# Parse command line arguments
MODE=""
BULK_SIZE=""
FLUSH_INTERVAL=""
QUERY_TYPE=""
LIMIT=""
COMMAND=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --start)
            COMMAND="start"
            shift
            ;;
        --stop)
            COMMAND="stop"
            shift
            ;;
        --restart)
            COMMAND="restart"
            shift
            ;;
        --status)
            COMMAND="status"
            shift
            ;;
        --setup-indices)
            COMMAND="setup"
            shift
            ;;
        --query)
            COMMAND="query"
            shift
            ;;
        --test-connection)
            COMMAND="test"
            shift
            ;;
        --mode)
            MODE="$2"
            shift 2
            ;;
        --bulk-size)
            BULK_SIZE="$2"
            shift 2
            ;;
        --flush-interval)
            FLUSH_INTERVAL="$2"
            shift 2
            ;;
        --type)
            QUERY_TYPE="$2"
            shift 2
            ;;
        --limit)
            LIMIT="$2"
            shift 2
            ;;
        --host)
            ES_HOST="$2"
            shift 2
            ;;
        -h|--help)
            show_usage
            exit 0
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            show_usage
            exit 1
            ;;
    esac
done

# Execute command
case "$COMMAND" in
    start)
        start_elasticsearch_streamer "$MODE" "$BULK_SIZE" "$FLUSH_INTERVAL"
        ;;
    stop)
        stop_elasticsearch_streamer
        ;;
    restart)
        stop_elasticsearch_streamer
        sleep 3
        start_elasticsearch_streamer "$MODE" "$BULK_SIZE" "$FLUSH_INTERVAL"
        ;;
    status)
        show_elasticsearch_status
        ;;
    setup)
        setup_elasticsearch_indices
        ;;
    query)
        query_elasticsearch "$QUERY_TYPE" "$LIMIT"
        ;;
    test)
        if check_elasticsearch_connection; then
            echo -e "${GREEN}Elasticsearch connection: OK${NC}"
        else
            echo -e "${RED}Elasticsearch connection: FAILED${NC}"
        fi
        ;;
    *)
        echo -e "${RED}No command specified${NC}"
        show_usage
        exit 1
        ;;
esac
